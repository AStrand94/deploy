# Deployment orchestration in NAV
Documentation related to the deployment orchestration into Kubernetes using Github Deployments.

## Overview
The deployment process goes as follows (key parts of the process is explained in detail below):

1. Install the NAV deployment GitHub application to your repository (one time operation)
2. Generate a deployment using GitHub's API as part of the CI process for each deployment you want to generate for your application.
3. `hookd` receives the deployment event, and
   1. Creates deployment status using GitHub's API for invalid deployments, marking the deployment as a failure, which effectively short circuits the deployment process, or
   2. Publishes message to Kafka for all valid deployments.
4. `deployd` receives message from Kafka regarding the deployment and triggers `kubectl apply`.
5. `deployd` publishes a message regarding the outcome of the deployment back to Kafka.
6. `hookd` receives message from Kafka and adds a corresponding deployment status using GitHub's API with the result of the deployment process.

## GitHub Application
Teams that want to opt-in to the automatic deployment process must install the [NAV deployment](https://github.com/apps/nav-deployment) GitHub application in their repositories. This is a one time operation per repository. Uninstalling the application at a later stage will remove the repository from the deployment process altogether.

### Repository webhook
The NAV Deployment application will install a webhook on the repository. This webhook will notify NAV about new deployments using [GitHub's deployment events](https://developer.github.com/v3/activity/events/types/#deploymentevent), and must not be removed from the repository.

If the webhook is for some reason manually deleted the automatic deployments will no longer work. The GitHub application will have to be re-installed for automatic deployments to start working again.

## GitHub Deployments
Deployments are generated by the teams themselves, using the [GitHub Deployment API](https://developer.github.com/v3/repos/deployments/#create-a-deployment).

### Environment / cluster
Use the `environment` parameter in the deployment to set the cluster name, for instance `prod-fss` or `dev-sbs`.

### Custom payload
Each deployment must contain a JSON-string in the `payload` parameter. The JSON-string must represent an object with two keys, `version` and `nais-yaml`.

#### version
This is the version of the payload itself. Use a tuple for the version number: `[<major>, <minor>, <patch>]`.

Currently the only valid version is `[0, 0, 0]`.

#### nais.yaml
The other key in the `payload` parameter is called `nais-yaml` and must contain the complete contents of your `nais.yaml` file, as a string.

## hookd
This service will receive all deployment events from GitHub. It is also responsible for installing the initial webhook in the repositories that installs the NAV Deployment GitHub Application.

Its main task is to validate deployment events, and publish messages to Kafka on new deployments, and report back to GitHub in the form of deployment statuses based on messages in Kafka published by `deployd` (described below), or in the case of invalid deployment events.

The validation part is done by checking if the signature attached to the deployment event is valid, and by checking the format of the deployment. Refer to the [GitHub documentation](https://developer.github.com/webhooks/securing/) as to how webhooks are secured.

## deployd
TODO: write docs